<!--
  ~ This file is part of Hopsworks
  ~ Copyright (C) 2020, Logical Clocks AB. All rights reserved
  ~
  ~ Hopsworks is free software: you can redistribute it and/or modify it under the terms of
  ~ the GNU Affero General Public License as published by the Free Software Foundation,
  ~ either version 3 of the License, or (at your option) any later version.
  ~
  ~ Hopsworks is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  ~ without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
  ~ PURPOSE.  See the GNU Affero General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License along with this program.
  ~ If not, see <https://www.gnu.org/licenses/>.
-->

<div ng-controller="FsIntegrationCtrl as fsIntegrationCtrl">
    <uib-tabset>
        <uib-tab index="0" heading="Databricks"
                 uib-tooltip="Configure Databricks integration"
                 class="fs-tab">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">

                    <h3>Instance: </h3>
                    <select class="col-lg-2 col-md-2 col-sm-2"
                            ng-model="fsIntegrationCtrl.dbInstance"
                            ng-click="$event.stopPropagation();"
                            style="z-index: {{100-$index}}; padding-left: 0px;">
                        <option ng-repeat="dbInstance in fsIntegrationCtrl.dbInstances" 
                                value="{{dbInstance.url}}">{{dbInstance.url}}</option>
                    </select>                   

                    <button class="btn btn-success" 
                            style="margin-left: 10px;"
                            ng-click="fsIntegrationCtrl.getClusters()">
                        Get Clusters
                        <i ng-if="fsIntegrationCtrl.clusterSpinner" 
                           style="margin-top: 2px" 
                           class="fa fa-spinner fa-spin pull-right" ></i>
                    </button>

                    <div style="margin-top: 11px; heigth: 2em;"><label ng-click="fsIntegrationCtrl.showAdd()">
                        <span class="glyphicon glyphicon-chevron-right" 
                              ng-if="!fsIntegrationCtrl.showAddInstance"></span>
                        <span class="glyphicon glyphicon-chevron-down"
                              ng-if="fsIntegrationCtrl.showAddInstance"></span>
                        Add Instance</label>
                   </div>

                   <div ng-if="fsIntegrationCtrl.showAddInstance">
                        <input type="text" class="col-lg-2 col-md-2 col-sm-2" 
                           placeholder="Enter a Databricks Instance"
                           ng-model="fsIntegrationCtrl.dbInstanceUrl">
                        <input type="text" class="col-lg-2 col-md-2 col-sm-2" 
                           placeholder="Enter a Databricks API Key"
                           ng-model="fsIntegrationCtrl.dbInstanceApiKey">
                        <button class="btn btn-success" 
                            style="margin-left: 10px;"
                            ng-click="fsIntegrationCtrl.addInstance()">
                            Add Instance
                            <i ng-if="fsIntegrationCtrl.addInstanceSpinner" 
                            style="margin-top: 2px" 
                            class="fa fa-spinner fa-spin pull-right" ></i>
                        </button>
                   </div> 

                    <h3 ng-show="fsIntegrationCtrl.dbClusters.length > 0">Clusters: </h3>

                    <table class="table table-hover" ng-show="fsIntegrationCtrl.dbClusters.length > 0">
                        <thead>
                        <tr>
                            <th style="width: 15%" class="fs-table"
                                ng-click="fsIntegrationCtrl.setSort('id')">
                                ID  
                                <span class="glyphicon sort-icon"
                                      ng-show="fsIntegrationCtrl.sortKey == 'id'"
                                      ng-class="{'glyphicon-chevron-up':fsIntegrationCtrl.sortReverse,'glyphicon-chevron-down':!fsIntegrationCtrl.sortReverse}"></span>
                            </th>
                            <th style="width: 15%" class="fs-table"
                                ng-click="fsIntegrationCtrl.setSort('name')">
                                Name  
                                <span class="glyphicon sort-icon"
                                      ng-show="fsIntegrationCtrl.sortKey == 'name'"
                                      ng-class="{'glyphicon-chevron-up':fsIntegrationCtrl.sortReverse,'glyphicon-chevron-down':!fsIntegrationCtrl.sortReverse}"></span>
                            </th>
                            <th style="width: 15%" class="fs-table"
                                ng-click="fsIntegrationCtrl.setSort('project')">
                                Project
                                <span class="glyphicon sort-icon"
                                      ng-show="fsIntegrationCtrl.sortKey == 'project'"
                                      ng-class="{'glyphicon-chevron-up':fsIntegrationCtrl.sortReverse,'glyphicon-chevron-down':!fsIntegrationCtrl.sortReverse}"></span>
                            </th>
                            <th style="width: 15%" class="fs-table"
                                ng-click="fsIntegrationCtrl.setSort('user')">
                                User 
                                <span class="glyphicon sort-icon"
                                      ng-show="fsIntegrationCtrl.sortKey == 'user'"
                                      ng-class="{'glyphicon-chevron-up':fsIntegrationCtrl.sortReverse,'glyphicon-chevron-down':!fsIntegrationCtrl.sortReverse}"></span>
                            </th>
                            <th style="width: 10%" class="fs-table"
                                ng-click="fsIntegrationCtrl.setSort('state')">
                                State 
                                <span class="glyphicon sort-icon"
                                      ng-show="fsIntegrationCtrl.sortKey == 'state'"
                                      ng-class="{'glyphicon-chevron-up':fsIntegrationCtrl.sortReverse,'glyphicon-chevron-down':!fsIntegrationCtrl.sortReverse}"></span>
                            </th>
                            <th style="width: 25%" class="fs-table">Configure</th>
                        </tr>
                        </thead>
                        <tbody class="table-hover">
                        <tr
                                dir-paginate="dbCluster in fsIntegrationCtrl.dbClusters | 
                                orderBy : fsIntegrationCtrl.sortFn:fsIntegrationCtrl.sortReverse | 
                                filter : fsIntegrationCtrl.scFilter:false | 
                                itemsPerPage : fsIntegrationCtrl.pageSize" class="fs-table"
                                pagination-id="clustertable">
                            <td class="fs-table">{{dbCluster.id}}</td>
                            <td class="fs-table">{{dbCluster.name}}</td>

                            <td class="fs-table">{{dbCluster.project}}</td>
                            <td class="fs-table">{{dbCluster.user.firstname}} {{dbCluster.user.lastname}}</td>
                            <td class="fs-table">{{dbCluster.state}}</td>
                            <td class="fs-table">
                                <select class="col-lg-7 col-md-7 col-sm-7"
                                        ng-if="!fsIntegrationCtrl.dataScientist"
                                        ng-model="dbCluster.targetUser"
                                        ng-click="$event.stopPropagation();"
                                        style="z-index: {{100-$index}}; padding-left: 0px; margin-right: 5px;">
                                    <option ng-repeat="member in fsIntegrationCtrl.projectMembers" 
                                            value="{{member.user.username}}">{{member.user.fname}} {{member.user.lname}}</option>
                                </select>
                                <button class="btn btn-success"
                                        style="margin-right: 10px;"
                                        ng-click="fsIntegrationCtrl.configure(dbCluster)">
                                    Configure
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <dir-pagination-controls
                        pagination-id="clustertable"
                        class="pull-right"
                        max-size="5"
                        direction-links="true"
                        boundary-links="true">
                    </dir-pagination-controls>
                </div>
            </div>
            
        </uib-tab>
        
        <uib-tab index="1" heading="Spark cluster"
                 uib-tooltip="Configure generic Spark cluster integration"
                 class="fs-tab">

            <div class="row">
                <div class="col-lg-7 col-md-7 col-sm-7">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th style="width: 5%" class="fs-table"></th>
                            <th style="width: 15%" class="fs-table"></th>
                        </tr>
                        </thead>
                        <tbody class="table-hover">
                            <tr>
                                <td class="fs-table">Download client jars</td>
                                <td class="fs-table">
                                    <div class="row">
                                        <div class="col-lg-3 col-md-3 col-sm-3">
                                            <button class="btn btn-success" 
                                                    style="margin-left: 10px;"
                                                    ng-click="fsIntegrationCtrl.downloadJars()">
                                                Download
                                            </button>
                                        </div>
                                        <div class="col-lg-5 col-md-5 col-sm-5" style="border-left: 2px solid #5f6368;">
                                            Extract the jars from the archive and add them as local resources to your Spark Job
                                        </div>
                                    </div>
                                </td>
                            </tr> 

                            <tr>
                                <td class="fs-table">Download certificates</td>
                                <td class="fs-table">
                                    <div class="row">
                                        <div class="col-lg-3 col-md-3 col-sm-3">
                                            <button class="btn btn-success" 
                                                    style="margin-left: 10px;"
                                                    ng-click="projectCtrl.getCerts()">
                                                Download
                                            </button>
                                        </div>
                                        <div class="col-lg-5 col-md-5 col-sm-5" style="border-left: 2px solid #5f6368;">
                                            Download the certificates and add them as local resources to your Spark job. Save the password in a file named <i>material_passwd</i> and add it as local resource.
                                        </div>
                                    </div>
                                </td>
                            </tr> 

                            <tr>
                                <td class="fs-table">Spark Configuration</td>
                                <td class="fs-table">
                                    <li ng-repeat="conf in fsIntegrationCtrl.sparkConfiguration">
                                        {{conf.propertyName}} {{conf.propertyValue}}
                                    </li>
                                </td>
                            </tr>
                        </tbody>
                    </table> 
                </div>
    
                <div class="col-lg-2 col-md-2 col-sm-2" style="margin-top: 10px; border-left: 4px solid #5f6368;">
                    This page walks you through the steps to configure an external
                    Spark cluster to be able to interact with the Hopsworks Feature Store.</br>

                    You can find the complete documentation at <a href="https://docs.hopsworks.ai">docs.hopsworks.ai</a>
                </div>
            </div>
 
        </uib-tab>

    </uib-tabset>
</div>